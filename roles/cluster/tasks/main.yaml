- name: make sure line 'dns=none' is set in /etc/NetworkManager/NetworkManager.conf
  ini_file:
    path: /etc/NetworkManager/NetworkManager.conf
    state: present
    no_extra_spaces: yes
    section: main
    option: dns
    value: none
    owner: root
    group: root
    mode: 0644
    backup: yes
  notify:
    - reload NetworkManager
- name: make sure devices are managed by NetworkManager
  ini_file:
    path: /etc/sysconfig/network-scripts/ifcfg-eth0
    state: absent
    no_extra_spaces: yes
    option: NM_CONTROLLED
    section: null
    owner: root
    group: root
    mode: 0644
    backup: yes
  notify:
    - reload NetworkManager
- name: make sure devices are managed by NetworkManager
  ini_file:
    path: /etc/sysconfig/network-scripts/ifcfg-eth1
    state: absent
    no_extra_spaces: yes
    option: NM_CONTROLLED
    section: null
    owner: root
    group: root
    mode: 0644
    backup: yes
  notify:
    - reload NetworkManager
- name: make sure hosts isn't overwritten on restart
  lineinfile:
    path: /etc/cloud/cloud.cfg
    line: "manage_etc_hosts: False"
    regexp: "^manage_etc_hosts"
- name: deploy hosts file
  template:
    src: hosts.j2
    dest: /etc/hosts
    mode: 0644
- name: deploy resolv.conf template
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: 0644
    backup: yes
  notify:
    - reload NetworkManager
- name: Install Base Packages
  yum:
    name:
    - wget
    - git
    - net-tools
    - bind-utils
    - yum-utils
    - iptables-services
    - bridge-utils
    - bash-completion
    - kexec-tools
    - sos
    - psacct
    - openshift-ansible
    state: present
  notify:
  - reboot machine
- name: Gather the rpm package facts
  package_facts:
    manager: auto
- name: try to reinstall openshift-ansible
  include_tasks: openshift-ansible.yaml
  when: "'openshift-ansible' not in ansible_facts.packages"
- name: Update installed Packages
  yum:
    name: "*"
    state: latest
  notify:
  - reboot machine
- name: get docker config
  command: cat /etc/sysconfig/docker-storage
  register: docker_storage
  ignore_errors: yes
- name: Install Docker
  yum:
    name:
    - docker-1.13.1
    - docker-novolume-plugin
    state: present
  when: docker_storage is not search("dm.thinpooldev")
- name: stop docker
  service:
    name: docker
    state: stopped
  when: docker_storage is not search("dm.thinpooldev")
- name: delete docker files
  file:
    path: /var/lib/docker
    state: absent
  when: docker_storage is not search("dm.thinpooldev")
- name: Edit Docker OPTIONS
  lineinfile:
    path: /etc/sysconfig/docker
    regexp: '^OPTIONS='
    line: OPTIONS='--log-driver=journald --signature-verification=false'
  notify:
  - restart docker
  when: docker_storage is not search("dm.thinpooldev")
- name: enable & start service docker-novolume
  systemd:
    name: docker-novolume-plugin
    enabled: yes
    state: started
  when: docker_storage is not search("dm.thinpooldev")
- name: set selinux policy
  selinux:
    policy: targeted
    state: enforcing
  when: docker_storage is not search("dm.thinpooldev")
- name: configure docker storage
  copy:
    content: |
      DEVS=/dev/xvdc
      VG=docker-vg
    dest: /etc/sysconfig/docker-storage-setup
    mode: u+rw,g+r,o+r
  when: docker_storage is not search("dm.thinpooldev")
- name: Delete existing docker storage configuration
  file: 
    path: /etc/sysconfig/docker-storage
    state: absent
  when: docker_storage is not search("dm.thinpooldev")
- name: run docker storage setup
  command: docker-storage-setup
  when: docker_storage is not search("dm.thinpooldev")
- name: extend Docker VG
  lvol:
    vg: docker-vg
    lv: docker-pool
    size: 60%VG
  when: docker_storage is not search("dm.thinpooldev")
- name: start docker
  service:
    name: docker
    state: started
    enabled: yes
- name: Making sure NetworkManager is started
  service:
    name: NetworkManager
    state: started
    enabled: yes